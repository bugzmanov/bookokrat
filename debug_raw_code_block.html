<span epub:type="pagebreak" id="page_18"/>&#160;1 //<span class="codeitalic">These sectors are for 2048-byte sectors</span>.<br/>&#160;&#160;&#160;//<span class="codeitalic">Multiply by 4 for devices with 512-byte sectors</span>.<br/>&#160;3 if(cur_cmd.sector&gt;=10000 &#38;&#38; cur_cmd.sector&lt;48000)<br/>&#160;&#160;&#160;&#160;&#160;tamperdetected=true;<br/>&#160;5<br/>&#160;&#160;&#160;//<span class="codeitalic">This is the legitimate read</span>.<br/>&#160;7 cur_cmd.last_result = storage_read_sectors(<br/>&#160;&#160;&#160;&#160;&#160;IF_MD2(cur_cmd.lun,) cur_cmd.sector,<br/>&#160;9&#160;&#160;&#160;MIN(READ_BUFFER_SIZE/SECTOR_SIZE, cur_cmd.count),<br/>&#160;&#160;&#160;&#160;&#160;cur_cmd.data[cur_cmd.data_select]<br/>11&#160;);<br/><br/>13 //<span class="codeitalic">Here, we wipe the buffer to demo antiforensics</span>.<br/>&#160;&#160;&#160;if(tamperdetected){<br/>15&#160;&#160;&#160;for(i=0;i&lt;READ_BUFFER_SIZE;i++)<br/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;cur_cmd.data[cur_cmd.data_select][i]=0xFF;<br/>17&#160;&#160;&#160;//<span class="codeitalic">Clobber the buffer for testing</span>.<br/>&#160;&#160;&#160;&#160;&#160;strcpy(cur_cmd.data[cur_cmd.data_select],<br/>19&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;"Never gonna let you down.");<br/><br/>21&#160;&#160;&#160;//<span class="codeitalic">Comment the following to make a harmless demo</span>.<br/>&#160;&#160;&#160;&#160;&#160;//<span class="codeitalic">This writes the buffer back to the disk</span>,<br/>23&#160;&#160;&#160;//<span class="codeitalic">eliminating any of the old contents</span>.<br/>&#160;&#160;&#160;&#160;&#160;if(cur_cmd.sector&gt;=48195)<br/>25&#160;&#160;&#160;&#160;&#160;storage_write_sectors(<br/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF_MD2(cur_cmd.lun,)<br/>27&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cur_cmd.sector,<br/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MIN(WRITE_BUFFER_SIZE/SECTOR_SIZE, cur_cmd.count),<br/>29&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cur_cmd.data[cur_cmd.data_select]);<br/>&#160;&#160;&#160;}